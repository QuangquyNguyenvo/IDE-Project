name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Sameko-GCC from latest release
        shell: pwsh
        run: |
          Write-Host "=== Downloading Sameko-GCC ==="
          $repo = "${{ github.repository }}"
          $apiUrl = "https://api.github.com/repos/$repo/releases/latest"
          
          # Get latest release assets
          $release = Invoke-RestMethod -Uri $apiUrl -Headers @{ "User-Agent" = "GitHub-Actions" }
          $asset = $release.assets | Where-Object { $_.name -eq "Sameko-GCC.zip" } | Select-Object -First 1
          
          if (-not $asset) {
            Write-Host "ERROR: Sameko-GCC.zip not found in latest release!"
            exit 1
          }
          
          Write-Host "Found: $($asset.name) ($([math]::Round($asset.size / 1MB, 2)) MB)"
          
          # Download
          $downloadUrl = $asset.browser_download_url
          Write-Host "Downloading from: $downloadUrl"
          Invoke-WebRequest -Uri $downloadUrl -OutFile "Sameko-GCC.zip" -UseBasicParsing
          
          # Extract to project root
          Write-Host "Extracting..."
          Expand-Archive -Path "Sameko-GCC.zip" -DestinationPath "." -Force
          Remove-Item "Sameko-GCC.zip"
          
          # Verify
          if (Test-Path "Sameko-GCC/bin/g++.exe") {
            Write-Host "✓ Sameko-GCC extracted successfully"
          } else {
            Write-Host "ERROR: g++.exe not found after extraction!"
            Get-ChildItem -Path "." -Depth 2 | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Get version info
        id: version
        shell: pwsh
        run: |
          $tagName = $env:GITHUB_REF -replace 'refs/tags/', ''
          $version = $tagName.TrimStart('v')
          echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Tag: $tagName, Version: $version"

      - name: Build Electron App
        run: npm run build:win -- -p never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Portable ZIP with folder structure
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $unpackedDir = "release_build/win-unpacked"
          $zipName = "release_build/sameko-dev-cpp-${version}-portable.zip"
          
          Write-Host "=== Creating Portable ZIP ==="
          Write-Host "Looking for unpacked directory: $unpackedDir"
          
          # List all files/folders in release_build for debugging
          Write-Host "Contents of release_build:"
          Get-ChildItem -Path "release_build" | ForEach-Object { Write-Host "  $($_.Name)" }
          
          if (Test-Path $unpackedDir) {
            Write-Host "Found win-unpacked directory"
            
            # Count files
            $fileCount = (Get-ChildItem -Path $unpackedDir -Recurse -File | Measure-Object).Count
            Write-Host "Total files in win-unpacked: $fileCount"
            
            # Verify Sameko-GCC is included
            $gccFolder = "$unpackedDir/resources/Sameko-GCC"
            $gccExe = "$gccFolder/bin/g++.exe"
            
            Write-Host "Checking for Sameko-GCC..."
            if (Test-Path $gccFolder) {
              Write-Host "✓ Sameko-GCC folder exists"
              # List what's inside
              Write-Host "  Contents of Sameko-GCC:"
              Get-ChildItem -Path $gccFolder | ForEach-Object { Write-Host "    $($_.Name)" }
              
              if (Test-Path $gccExe) {
                Write-Host "✓ g++.exe found"
              } else {
                Write-Host "⚠ g++.exe not at expected path, checking bin folder..."
                Get-ChildItem -Path "$gccFolder/bin" -ErrorAction SilentlyContinue | Select-Object -First 10 | ForEach-Object { Write-Host "    $($_.Name)" }
              }
            } else {
              Write-Host "✗ ERROR: Sameko-GCC folder not found at: $gccFolder"
              Write-Host "Checking resources folder:"
              Get-ChildItem -Path "$unpackedDir/resources" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  $($_.Name)" }
              
              # Check if it's nested differently
              Write-Host "Searching for g++.exe anywhere in resources..."
              Get-ChildItem -Path "$unpackedDir/resources" -Recurse -Filter "g++.exe" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  Found: $($_.FullName)" }
              exit 1
            }
            
            # Create temp structure with folder name
            $tempRoot = "release_build/temp-portable"
            $folderName = "Sameko Dev C++ Portable"
            $targetPath = "$tempRoot/$folderName"
            
            if (Test-Path $tempRoot) {
              Remove-Item -Recurse -Force $tempRoot
            }
            
            # Copy win-unpacked to temp with proper folder name
            Write-Host "Copying to: $targetPath"
            Copy-Item -Path $unpackedDir -Destination $targetPath -Recurse
            
            # Create ZIP (user extracts and gets "Sameko Dev C++ Portable" folder)
            Write-Host "Creating ZIP archive..."
            Compress-Archive -Path $targetPath -DestinationPath $zipName -Force
            
            # Get ZIP size
            $zipSize = [math]::Round((Get-Item $zipName).Length / 1MB, 2)
            Write-Host "✓ Created: $zipName ($zipSize MB)"
            
            # Show ZIP structure
            Write-Host "ZIP top-level structure:"
            7z l $zipName -ba | Select-Object -First 10
            
            # Cleanup
            Remove-Item -Recurse -Force $tempRoot
            
            # Remove portable exe (we only want the ZIP)
            $portableExe = "release_build/sameko-dev-cpp-${version}-portable.exe"
            if (Test-Path $portableExe) {
              Remove-Item -Force $portableExe
              Write-Host "✓ Removed portable exe"
            }
            
          } else {
            Write-Host "ERROR: win-unpacked directory not found!"
            Write-Host "Available in release_build:"
            Get-ChildItem -Path "release_build" -Recurse -Depth 1 | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Verify build artifacts
        shell: pwsh
        run: |
          Write-Host "=== Final Build Artifacts ==="
          Get-ChildItem -Path "release_build" | ForEach-Object { 
            $size = [math]::Round($_.Length / 1MB, 2)
            Write-Host "$($_.Name) - ${size} MB"
          }
          
          # Verify required files exist
          $version = "${{ steps.version.outputs.version }}"
          $requiredFiles = @(
            "release_build/sameko-dev-cpp-setup-${version}.exe",
            "release_build/sameko-dev-cpp-${version}-portable.zip",
            "release_build/latest.yml"
          )
          
          foreach ($file in $requiredFiles) {
            if (Test-Path $file) {
              Write-Host "✓ $file exists"
            } else {
              Write-Host "✗ $file MISSING!"
              exit 1
            }
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Sameko Dev C++ ${{ steps.version.outputs.tag_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release_build/sameko-dev-cpp-setup-*.exe
            release_build/*-portable.zip
            release_build/latest.yml
            release_build/*.blockmap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
