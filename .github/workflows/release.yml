name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get version info
        id: version
        shell: pwsh
        run: |
          $tagName = $env:GITHUB_REF -replace 'refs/tags/', ''
          $version = $tagName.TrimStart('v')
          echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Tag: $tagName, Version: $version"

      - name: Build Electron App
        run: npm run build:win -- -p never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Portable ZIP with folder structure
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $portableExe = "release_build/sameko-dev-cpp-${version}-portable.exe"
          $zipName = "release_build/sameko-dev-cpp-${version}-portable.zip"
          
          Write-Host "=== Creating Portable ZIP ==="
          Write-Host "Looking for: $portableExe"
          
          # List all files in release_build for debugging
          Write-Host "Files in release_build:"
          Get-ChildItem -Path "release_build" | ForEach-Object { Write-Host "  $($_.Name)" }
          
          if (Test-Path $portableExe) {
            Write-Host "Found portable exe, extracting..."
            
            # Create temp directory structure
            $tempRoot = "release_build/temp-portable"
            $folderName = "Sameko Dev C++ Portable"
            $extractPath = "$tempRoot/$folderName"
            
            # Clean up if exists
            if (Test-Path $tempRoot) {
              Remove-Item -Recurse -Force $tempRoot
            }
            
            New-Item -ItemType Directory -Path $extractPath -Force | Out-Null
            
            # Extract portable exe (NSIS portable is a self-extracting 7z archive)
            Write-Host "Extracting with 7z..."
            7z x $portableExe -o"$extractPath" -y
            
            # Verify extraction
            $extractedFiles = Get-ChildItem -Path $extractPath -Recurse | Measure-Object
            Write-Host "Extracted $($extractedFiles.Count) items"
            
            if ($extractedFiles.Count -eq 0) {
              Write-Host "ERROR: Extraction failed - no files extracted"
              exit 1
            }
            
            # Verify Sameko-GCC is included
            $gccPath = "$extractPath/resources/Sameko-GCC/bin/g++.exe"
            if (Test-Path $gccPath) {
              Write-Host "✓ Sameko-GCC bundled successfully"
            } else {
              Write-Host "⚠ Warning: Sameko-GCC not found at expected path: $gccPath"
              Write-Host "Checking resources folder structure:"
              Get-ChildItem -Path "$extractPath/resources" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  $($_.Name)" }
            }
            
            # Create ZIP with the folder inside
            # User will extract and get "Sameko Dev C++ Portable" folder ready to use
            Write-Host "Creating ZIP archive..."
            Compress-Archive -Path $extractPath -DestinationPath $zipName -Force
            
            # Get ZIP size
            $zipSize = [math]::Round((Get-Item $zipName).Length / 1MB, 2)
            Write-Host "✓ Created: $zipName ($zipSize MB)"
            
            # Show top-level ZIP structure
            Write-Host "ZIP structure (top-level):"
            7z l $zipName -ba | Select-Object -First 15
            
            # Cleanup
            Remove-Item -Recurse -Force $tempRoot
            Remove-Item -Force $portableExe
            Write-Host "✓ Cleaned up temp files"
            
          } else {
            Write-Host "ERROR: Portable exe not found!"
            Write-Host "Available files in release_build:"
            Get-ChildItem -Path "release_build" -Recurse | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Verify build artifacts
        shell: pwsh
        run: |
          Write-Host "=== Final Build Artifacts ==="
          Get-ChildItem -Path "release_build" | ForEach-Object { 
            $size = [math]::Round($_.Length / 1MB, 2)
            Write-Host "$($_.Name) - ${size} MB"
          }
          
          # Verify required files exist
          $version = "${{ steps.version.outputs.version }}"
          $requiredFiles = @(
            "release_build/sameko-dev-cpp-setup-${version}.exe",
            "release_build/sameko-dev-cpp-${version}-portable.zip",
            "release_build/latest.yml"
          )
          
          foreach ($file in $requiredFiles) {
            if (Test-Path $file) {
              Write-Host "✓ $file exists"
            } else {
              Write-Host "✗ $file MISSING!"
              exit 1
            }
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Sameko Dev C++ ${{ steps.version.outputs.tag_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release_build/sameko-dev-cpp-setup-*.exe
            release_build/*-portable.zip
            release_build/latest.yml
            release_build/*.blockmap
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
